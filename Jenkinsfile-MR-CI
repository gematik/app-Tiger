@Library('gematik-jenkins-shared-library@master') _

def REPO_URL = 'https://build.top.local/source/git/Testtools/tiger.git'
def GITLAB_PROJECT_ID = '644'
def JIRA_PROJECT_ID = 'TGR'
def TAG_NAME = "ci/build"
def IS_MERGE_REQUEST = env.GITLAB_OBJECT_KIND == 'merge_request'
def VERSION = '0.1-SNAPSHOT'
def BRANCH = 'master'

pipeline {
    options {
        disableConcurrentBuilds()
        buildDiscarder logRotator(artifactDaysToKeepStr: '', artifactNumToKeepStr: '', daysToKeepStr: '', numToKeepStr: '5')
    }
    agent { label 'Docker-Maven-LATEST' }

    tools {
        maven 'Default'
    }

    stages {
        stage('Initialize') {
            steps {
                gitSetIdentity()
                createPipelineTriggers()
            }
        }
         stage('gitCreateBranch') {
             //nur für Executables nicht für Libraries nötig
             when { branch BRANCH}
             steps {
                 gitCreateBranch()
             }
         }
        stage('Merge Request') {
            when { changeRequest target: BRANCH }
            steps {
                echo "Merge request target branch: master"
                sh """
                        git merge origin/master -q
                        """
            }
        }
        stage('set Version') {
            //nur für Executables nicht für Libraries nötig
            steps {
                script{
                    def  versionJira = jiraCheckAndGetSingleVersion(jiraGetVersions(JIRA_PROJECT_ID))
                    VERSION = "${versionJira}-${BUILD_NUMBER}"
                    mavenSetVersion(VERSION)
                }
            }
        }
        stage('Build') {
            steps {
                mavenBuild()
            }
        }
        stage('Test') {
            steps {
                mavenVerify()
            }
        }
        stage('OwaspScan') {
            when { branch 'owasp' }
            steps {
                sh "git merge origin/master -q"
                mavenOwaspScan()
            }
        }
        stage('Sonar') {
            steps {
                mavenCheckWithSonarQube("pom.xml", '', false)
            }
        }
        stage('deploy') {
            when { branch BRANCH}
            steps {
                sh "mvn deploy -DskipTests -DaltDeploymentRepository=releases::default::https://build.top.local/nexus/content/repositories/releases"
            }
        }

       /* stage('Publish artifact and docker image') {
            when { branch BRANCH }
            steps {
                script {
                    //mavenDeploy()
                    docker.withRegistry('https://gstopdr1.top.local', "Harbor") {
                        def tigerProxy = docker.image("tiger/tiger-proxy:${VERSION}")
                        tigerProxy.push("${VERSION}")
                    }
                }
            }
        }
*/
        stage('Tag and Push CI-build') {
        when { branch BRANCH}
            steps {
                gitCreateAndPushTag(JIRA_PROJECT_ID)
            }
        }
       stage('GitLab-Update-Snapshot') {
            when { branch BRANCH}
            steps {
                gitLabUpdateMavenSnapshot(JIRA_PROJECT_ID, GITLAB_PROJECT_ID)
            }
        }
    }
    post {
        always {
            archiveArtifacts allowEmptyArchive: true, artifacts: 'tiger-standalone-proxy/target/site/serenity/**/*', fingerprint: false
            publishHTML (target: [
                allowMissing: false,
                alwaysLinkToLastBuild: false,
                keepAll: true,
                reportDir: 'tiger-standalone-proxy/target/site/serenity',
                reportFiles: 'index.html',
                reportName: "Proxy Standalone UI Report"
            ])
        }
    }
}

void createPipelineTriggers() {
    script {
        def triggers = []
        if (env.BRANCH_NAME == 'owasp') {
            triggers = [cron('H H(0-3) * * 1-5')]
        }
        properties([
                pipelineTriggers(triggers)
        ])
    }
}
